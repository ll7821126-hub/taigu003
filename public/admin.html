<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾Œå°ç®¡ç†ç³»çµ± - Stock Tracker</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #0f172a;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #111827;
    }
    .login-card {
      max-width: 400px;
      margin: 120px auto;
      padding: 30px;
      background: #020617;
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.4);
      color:#e5e7eb;
    }
    .login-card h3 {font-weight:800;}
    .login-card .form-label{font-size:13px;color:#9ca3af;}
    .login-card .form-control{
      background:#020617;
      border-radius:999px;
      border:1px solid #1f2937;
      color:#e5e7eb;
      font-size:14px;
    }
    .login-card .form-control:focus{
      border-color:#22c55e;
      box-shadow:0 0 0 1px rgba(34,197,94,.6);
      background:#020617;
      color:#e5e7eb;
    }
    .login-card .btn-primary{
      border-radius:999px;
      background:linear-gradient(135deg,#22c55e,#4ade80);
      border:none;
      font-weight:700;
      box-shadow:0 10px 30px rgba(34,197,94,.45);
    }
    .login-card .btn-primary:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
    }

    .dashboard { display: none; padding: 18px; }

    .page-header {
      padding: 16px 22px;
      margin-bottom: 14px;
      border-radius: 18px;
      background: radial-gradient(circle at top left,#1f2937,#020617 60%);
      box-shadow: 0 20px 35px rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.45);
      color:#e5e7eb;
    }
    .page-title {
      font-size:20px;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .page-subtitle {
      font-size:12px;
      color:#9ca3af;
    }
    .pill {
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,0.8);
      border:1px solid rgba(148,163,184,0.4);
      font-size:11px;
      color:#e5e7eb;
    }
    .header-right .btn {
      border-radius:999px;
      font-size:12px;
      padding:6px 14px;
    }
    .btn-icon{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .stat-card {
      background: linear-gradient(135deg, #020617, #020617);
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: 0 12px 22px rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.35);
      color:#e5e7eb;
    }
    .stat-title { font-size:12px; color:#9ca3af; }
    .stat-value { font-size:20px; font-weight:800; }

    .badge-up { background:#fee2e2; color:#b91c1c; }
    .badge-down { background:#d1fae5; color:#065f46; }
    .text-up { color:#fecaca; }
    .text-down { color:#6ee7b7; }

    .tab-pill.nav-pills .nav-link {
      border-radius: 999px;
      padding: 5px 14px;
      font-size: 12px;
      color:#9ca3af;
      border:1px solid transparent;
    }
    .tab-pill.nav-pills .nav-link:hover{
      border-color:rgba(148,163,184,0.5);
    }
    .tab-pill.nav-pills .nav-link.active {
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color:#ecfdf5;
      border:none;
    }

    .search-input { max-width: 260px; }

    .card-main {
      background: #020617;
      border-radius:18px;
      box-shadow:0 18px 30px rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.4);
    }

    .client-group-card {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      background: radial-gradient(circle at top left,#020617,#020617 65%);
      margin-bottom: 10px;
      color:#e5e7eb;
    }
    .client-group-header {
      padding: 8px 12px;
      border-bottom: 1px solid rgba(148,163,184,0.35);
      background: radial-gradient(circle at top left,#111827,#020617 70%);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size: 13px;
    }
    .client-group-body { padding: 8px 10px; }
    .view-toggle .btn {
      font-size: 12px;
      border-radius:999px;
    }

    .client-link {
      cursor: pointer;
      color: #38bdf8;
      text-decoration: underline;
      font-weight:600;
    }
    .client-link:hover {
      color: #0ea5e9;
    }

    .table-dark {
      background:linear-gradient(90deg,#020617,#020617);
      color:#9ca3af;
      border-bottom:1px solid rgba(148,163,184,0.4);
    }
    .table-dark th{
      border-bottom-color:rgba(148,163,184,0.4)!important;
      font-size:11px;
      letter-spacing:0.03em;
    }
    .table-hover tbody tr:hover{
      background-color:rgba(15,23,42,0.85);
    }
    .table-striped>tbody>tr:nth-of-type(odd)>*{
      background-color:#020617;
    }
    .table-striped>tbody>tr:nth-of-type(even)>*{
      background-color:#020617;
    }
    tbody td{
      border-bottom:1px solid rgba(31,41,55,0.8)!important;
      color:#e5e7eb;
      font-size:12px;
    }

    .side-summary .stat-card{
      background:radial-gradient(circle at top left,#020617,#020617 70%);
    }

    .form-select, .form-control{
      background:#020617;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      color:#e5e7eb;
      font-size:12px;
    }
    .form-select:focus, .form-control:focus{
      background:#020617;
      color:#e5e7eb;
      border-color:#22c55e;
      box-shadow:0 0 0 1px rgba(34,197,94,.6);
    }
    .form-check-input{
      cursor:pointer;
    }

    .toolbar-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:10px;
    }
    .toolbar-left{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .toolbar-right{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .mini-label{
      font-size:11px;
      color:#9ca3af;
      margin-right:4px;
    }

    .modal-content{
      background:#020617;
      color:#e5e7eb;
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.6);
    }
    .modal-header{
      border-bottom-color:rgba(31,41,55,0.9);
    }
    .modal-footer{
      border-top-color:rgba(31,41,55,0.9);
    }
    .modal-title{font-weight:800;}

    .badge.bg-primary{
      background:linear-gradient(135deg,#38bdf8,#0ea5e9)!important;
    }
    .badge.bg-secondary{
      background:#4b5563!important;
    }

    .btn-outline-secondary.btn-sm,
    .btn-success.btn-sm,
    .btn-outline-danger.btn-sm{
      border-radius:999px;
      font-size:11px;
      padding:5px 12px;
    }
    .btn-outline-secondary.btn-sm{
      border-color:#4b5563;
      color:#e5e7eb;
      background:#020617;
    }
    .btn-outline-secondary.btn-sm:hover{
      background:#111827;
    }
    .btn-success.btn-sm{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      border:none;
    }
    .btn-success.btn-sm:hover{
      filter:brightness(1.05);
    }
    .btn-outline-danger.btn-sm{
      border-color:#ef4444;
      color:#fecaca;
      background:#020617;
    }
    .btn-outline-danger.btn-sm:hover{
      background:#7f1d1d;
    }

    .small-muted{font-size:11px;color:#9ca3af;}
  </style>
</head>
<body>

  <!-- ç™»éŒ„ä»‹é¢ -->
  <div id="loginSection" class="container">
    <div class="login-card">
      <h3 class="text-center mb-4">å¾Œå°ç®¡ç†ç™»å…¥</h3>

      <div class="mb-3">
        <label class="form-label">å¸³è™Ÿ</label>
        <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">å¯†ç¢¼</label>
        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="form-control">
      </div>

      <button onclick="handleLogin()" class="btn btn-primary w-100 mt-2">ç™»å…¥ç³»çµ±</button>
      <p id="loginError" class="text-danger mt-3 text-center" style="display:none;">å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤</p>
    </div>
  </div>

  <!-- å„€è¡¨æ¿ -->
  <div id="dashboardSection" class="dashboard container-fluid">
    <!-- é ‚éƒ¨æ¢ -->
    <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <div class="page-title">
          å®¢æˆ¶æŒå€‰ç›£æ§é¢æ¿
          <span class="pill">Admin Console</span>
        </div>
        <div class="page-subtitle">
          å³æ™‚æª¢è¦–æ‰€æœ‰å®¢æˆ¶çš„æŒè‚¡ã€æ”¶ç›Šèˆ‡é¢¨éšªç‹€æ…‹
        </div>
        <div id="lastFetchTime" class="small-muted mt-1"></div>
      </div>

      <div class="header-right d-flex align-items-center gap-2 flex-wrap">
        <div class="form-check form-switch text-nowrap">
          <input class="form-check-input" type="checkbox" id="autoRefreshSwitch">
          <label class="form-check-label small text-light" for="autoRefreshSwitch">è‡ªå‹•åˆ·æ–° (10 ç§’)</label>
        </div>
        <button onclick="exportCSV()" class="btn btn-outline-secondary btn-sm btn-icon">
          <span>ğŸ“¥ åŒ¯å‡º CSV</span>
        </button>
        <button onclick="fetchData()" class="btn btn-success btn-sm btn-icon">
          <span>ğŸ”„ ç«‹å³åˆ·æ–°</span>
        </button>
        <button onclick="logout()" class="btn btn-outline-danger btn-sm btn-icon">
          <span>ç™»å‡º</span>
        </button>
      </div>
    </div>

    <!-- æ•´é«”çµ±è¨ˆ -->
    <div class="row g-3 mb-3 side-summary">
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">ç¸½æŒå€‰ç­†æ•¸</div>
          <div class="stat-value" id="statCount">-</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">ç¸½æŒè‚¡æ•¸é‡</div>
          <div class="stat-value" id="statQty">-</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">ç¸½æŠ•å…¥é‡‘é¡</div>
          <div class="stat-value" id="statCost">-</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">æ¨è–¦é£†è‚¡æª”æ•¸</div>
          <div class="stat-value" id="statRecCount">-</div>
        </div>
      </div>
    </div>

    <!-- tab -->
    <ul class="nav nav-pills mb-2 tab-pill" id="typeTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tabAll" data-bs-toggle="pill" type="button"
                onclick="setFilterType('all')">å…¨éƒ¨</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabRec" data-bs-toggle="pill" type="button"
                onclick="setFilterType('rec')">æ¨è–¦é£†è‚¡</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabNormal" data-bs-toggle="pill" type="button"
                onclick="setFilterType('normal')">ä¸€èˆ¬æŒè‚¡</button>
      </li>
    </ul>

    <!-- ä¸»å…§å®¹ -->
    <div class="row">
      <div class="col-lg-9 mb-3">
        <div class="card card-main">
          <div class="card-body">

            <!-- å·¥å…·åˆ—ï¼šæœå°‹ + æ’åº (å·²ç§»åˆ°è¡¨æ ¼ä¸Šæ–¹) -->
            <div class="toolbar-row">
              <div class="toolbar-left">
                <span class="mini-label">ç¯©é¸</span>
                <input type="text" id="searchInput"
                       class="form-control form-control-sm search-input"
                       placeholder="æœå°‹è‚¡ç¥¨åç¨± / ä»£ç¢¼">
              </div>
              <div class="toolbar-right">
                <span class="mini-label">æ’åº</span>
                <select id="sortSelect" class="form-select form-select-sm" style="min-width: 190px;">
                  <option value="time_desc">æŒ‰æäº¤æ™‚é–“ï¼ˆæ–° â†’ èˆŠï¼‰</option>
                  <option value="value_desc">æŒ‰ä¼°ç®—å¸‚å€¼ï¼ˆå¤§ â†’ å°ï¼‰</option>
                  <option value="value_asc">æŒ‰ä¼°ç®—å¸‚å€¼ï¼ˆå° â†’ å¤§ï¼‰</option>
                </select>
              </div>
            </div>

            <!-- è¦–åœ–åˆ‡æ› -->
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="small-muted">å·¦æ–¹ç‚ºå…¨éƒ¨æŒå€‰åˆ—è¡¨ï¼Œå¯é»å®¢æˆ¶å§“åæŸ¥çœ‹å®¢æˆ¶æª”æ¡ˆèˆ‡æç›Šç´°ç¯€ã€‚</div>
              <div class="btn-group btn-group-sm view-toggle" role="group" aria-label="View toggle">
                <button type="button" class="btn btn-outline-secondary active" id="btnViewTable"
                        onclick="setViewMode('table')">è¡¨æ ¼è¦–åœ–</button>
                <button type="button" class="btn btn-outline-secondary" id="btnViewClient"
                        onclick="setViewMode('client')">ä¾å®¢æˆ¶åˆ†çµ„</button>
              </div>
            </div>

            <!-- è¡¨æ ¼è¦–åœ– -->
            <div id="tableView">
              <div class="table-responsive">
                <table class="table table-hover table-striped align-middle mb-0">
                  <thead class="table-dark">
                    <tr>
                      <th>å®¢æˆ¶å§“å</th>
                      <th>è‚¡ç¥¨åç¨±</th>
                      <th>ä»£ç¢¼</th>
                      <th class="text-end">æŒè‚¡æ•¸</th>
                      <th class="text-end">è²·å…¥åƒ¹</th>
                      <th class="text-end">å³æ™‚åƒ¹</th>
                      <th class="text-end">ä¼°ç®—å¸‚å€¼</th>
                      <th class="text-end">ä¼°ç®—ç›ˆè™§</th>
                      <th>æ˜¯å¦æ¨è–¦</th>
                      <th>æäº¤æ™‚é–“</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="tableBody"></tbody>
                </table>
              </div>
            </div>

            <!-- å®¢æˆ¶åˆ†çµ„è¦–åœ– -->
            <div id="clientView" style="display:none;">
              <div id="clientGroupContainer"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³å´ç¸½è¦½ -->
      <div class="col-lg-3 mb-3">
        <div class="stat-card mb-3">
          <h6 class="mb-2"âš–ï¸ æ•´é«”ç›ˆè™§æ¦‚æ³</h6>
          <div class="d-flex flex-column gap-1">
            <div class="d-flex justify-content-between">
              <span class="stat-title">ä¼°ç®—ç¸½å¸‚å€¼</span>
              <span id="statValue" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="stat-title">ä¼°ç®—ç¸½ç›ˆè™§</span>
              <span id="statPnl" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="stat-title">æ•´é«”å ±é…¬ç‡</span>
              <span id="statPnlRate" class="fw-semibold">-</span>
            </div>
          </div>
        </div>

        <div class="stat-card">
          <h6 class="mb-2">ğŸ’¡ æ“ä½œæç¤º</h6>
          <small class="text-muted small-muted">
            â€§ é»ã€Œå®¢æˆ¶å§“åã€å¯æŸ¥çœ‹å®Œæ•´å®¢æˆ¶æª”æ¡ˆèˆ‡æŒå€‰è³‡æ–™<br>
            â€§ æ’åºé¸å–®å¯æŒ‰ä¼°ç®—å¸‚å€¼æˆ–æ™‚é–“æ’åºè‚¡ç¥¨åˆ—è¡¨<br>
            â€§ é–‹å•Ÿè‡ªå‹•åˆ·æ–°å¾Œï¼Œç³»çµ±æ¯ 10 ç§’æ›´æ–°å³æ™‚è‚¡åƒ¹èˆ‡çµ±è¨ˆæ•¸å­—
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- å®¢æˆ¶è©³ç´°è³‡è¨Šå½ˆçª— -->
  <div class="modal fade" id="clientDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">å®¢æˆ¶è©³ç´°è³‡è¨Š</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
        </div>
        <div class="modal-body">
          <div id="clientDetailBody"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = '/api';

    let allData = [];
    let viewMode = 'table';
    let filterType = 'all';
    let searchText = '';
    let autoRefreshTimer = null;
    let sortMode = 'time_desc';

    if (localStorage.getItem('adminToken')) {
      showDashboard();
    }

    async function handleLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const errorEl = document.getElementById('loginError');

      errorEl.style.display = 'none';
      errorEl.textContent = '';

      try {
        const res = await fetch(`${API_BASE}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const result = await res.json();

        if (result.success) {
          localStorage.setItem('adminToken', result.token || 'admin-fixed-token');
          showDashboard();
        } else {
          errorEl.textContent = result.message || 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
          errorEl.style.display = 'block';
        }
      } catch (e) {
        errorEl.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        errorEl.style.display = 'block';
      }
    }

    function showDashboard() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'block';
      fetchData();
    }

    function logout() {
      localStorage.removeItem('adminToken');
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
        document.getElementById('autoRefreshSwitch').checked = false;
      }
      document.getElementById('dashboardSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    }

    function setViewMode(mode) {
      viewMode = mode;
      document.getElementById('tableView').style.display = mode === 'table' ? 'block' : 'none';
      document.getElementById('clientView').style.display = mode === 'client' ? 'block' : 'none';

      document.getElementById('btnViewTable').classList.toggle('active', mode === 'table');
      document.getElementById('btnViewClient').classList.toggle('active', mode === 'client');

      render();
    }

    function setFilterType(type) {
      filterType = type;
      document.getElementById('tabAll').classList.toggle('active', type === 'all');
      document.getElementById('tabRec').classList.toggle('active', type === 'rec');
      document.getElementById('tabNormal').classList.toggle('active', type === 'normal');
      render();
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
      searchText = e.target.value.trim().toLowerCase();
      render();
    });

    document.getElementById('sortSelect').addEventListener('change', (e) => {
      sortMode = e.target.value;
      render();
    });

    document.getElementById('autoRefreshSwitch').addEventListener('change', (e) => {
      if (e.target.checked) {
        fetchData();
        autoRefreshTimer = setInterval(fetchData, 10000);
      } else {
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
        }
      }
    });

    window.addEventListener('beforeunload', () => {
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    });

    async function fetchData() {
      const tbody = document.getElementById('tableBody');
      const clientContainer = document.getElementById('clientGroupContainer');
      tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>';
      clientContainer.innerHTML = '<div class="text-center text-muted">è¼‰å…¥ä¸­...</div>';

      try {
        const res = await fetch(`${API_BASE}/get_data`);
        const data = await res.json();
        const list = Array.isArray(data) ? data : [];

        let tempData = list;

        const codes = [...new Set(tempData.map(r => r.code).filter(Boolean))];

        if (codes.length > 0) {
          try {
            const priceRes = await fetch(`${API_BASE}/prices`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ codes })
            });
            const priceMap = await priceRes.json();

            tempData = tempData.map(row => {
              const codeKey = String(row.code || '');
              const price = priceMap[codeKey];
              return { ...row, currentPrice: typeof price === 'number' ? price : undefined };
            });
          } catch (e) {
            console.warn('å–å¾—å³æ™‚åƒ¹æ ¼å¤±æ•—ï¼Œæ”¹ç”¨æˆæœ¬åƒ¹ç•¶ç¾åƒ¹', e);
          }
        }

        allData = tempData;

        document.getElementById('lastFetchTime').textContent =
          'æœ€å¾Œåˆ·æ–°ï¼š' + new Date().toLocaleString('zh-TW');

        render();
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">è¼‰å…¥å¤±æ•—</td></tr>';
        clientContainer.innerHTML = '<div class="text-center text-danger">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    function getFilteredAndSortedData() {
      let data = allData.filter(row => {
        if (filterType === 'rec' && row.recommendType !== 'yes') return false;
        if (filterType === 'normal' && row.recommendType === 'yes') return false;

        if (searchText) {
          const name = (row.stockName || '').toLowerCase();
          const code = (row.code || '').toLowerCase();
          if (!name.includes(searchText) && !code.includes(searchText)) return false;
        }
        return true;
      });

      data.sort((a, b) => {
        const qtyA = Number(a.quantity) || 0;
        const costA = Number(a.cost) || 0;
        const curA  = Number(a.currentPrice ?? a.cost) || 0;
        const valueA = qtyA * curA;

        const qtyB = Number(b.quantity) || 0;
        const costB = Number(b.cost) || 0;
        const curB  = Number(b.currentPrice ?? b.cost) || 0;
        const valueB = qtyB * curB;

        if (sortMode === 'value_desc') {
          return valueB - valueA;
        } else if (sortMode === 'value_asc') {
          return valueA - valueB;
        } else {
          return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        }
      });

      return data;
    }

    function render() {
      const data = getFilteredAndSortedData();
      const tbody = document.getElementById('tableBody');
      const clientContainer = document.getElementById('clientGroupContainer');

      let totalCount = data.length;
      let totalQty = 0;
      let totalCostAmount = 0;
      let totalValue = 0;
      let recCount = 0;

      data.forEach(row => {
        const qty  = Number(row.quantity) || 0;
        const cost = Number(row.cost) || 0;
        const cur  = Number(row.currentPrice ?? row.cost) || 0;

        totalQty        += qty;
        totalCostAmount += qty * cost;
        totalValue      += qty * cur;
        if (row.recommendType === 'yes') recCount++;
      });

      document.getElementById('statCount').textContent = totalCount;
      document.getElementById('statQty').textContent   = totalQty.toLocaleString('zh-TW');
      document.getElementById('statCost').textContent  = totalCostAmount.toLocaleString('zh-TW', { maximumFractionDigits: 0 });
      document.getElementById('statRecCount').textContent = recCount;
      document.getElementById('statValue').textContent = totalValue.toLocaleString('zh-TW', { maximumFractionDigits: 0 });

      const totalPnl = totalValue - totalCostAmount;
      const pnlEl = document.getElementById('statPnl');
      const rateEl = document.getElementById('statPnlRate');

      if (totalCostAmount > 0) {
        const pnlRate = totalPnl / totalCostAmount * 100;
        pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + totalPnl.toFixed(0);
        pnlEl.className = totalPnl >= 0 ? 'fw-semibold text-up' : 'fw-semibold text-down';

        rateEl.textContent = (pnlRate >= 0 ? '+' : '') + pnlRate.toFixed(2) + '%';
        rateEl.className = pnlRate >= 0 ? 'fw-semibold text-up' : 'fw-semibold text-down';
      } else {
        pnlEl.textContent = '-';
        pnlEl.className = 'fw-semibold';
        rateEl.textContent = '-';
        rateEl.className = 'fw-semibold';
      }

      if (viewMode === 'table') {
        if (!data.length) {
          tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
        } else {
          tbody.innerHTML = '';
          data.forEach(row => {
            const qty  = Number(row.quantity) || 0;
            const cost = Number(row.cost) || 0;
            const cur  = Number(row.currentPrice ?? row.cost) || 0;
            const value = qty * cur;
            const pnl   = qty * (cur - cost);
            const rate  = cost > 0 ? (cur - cost) / cost * 100 : 0;

            const badgeClass = pnl >= 0 ? 'badge-up' : 'badge-down';
            const rateStr    = (rate >= 0 ? '+' : '') + rate.toFixed(2) + '%';

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <span class="client-link"
                      onclick='showClientDetail(${JSON.stringify(row).replace(/'/g,"&#39;")})'>
                  ${row.client || ''}
                </span>
              </td>
              <td>${row.stockName || ''}</td>
              <td>${row.code || ''}</td>
              <td class="text-end">${qty.toLocaleString('zh-TW')}</td>
              <td class="text-end">${cost || ''}</td>
              <td class="text-end">${cur || ''}</td>
              <td class="text-end">${value ? value.toLocaleString('zh-TW', { maximumFractionDigits: 0 }) : ''}</td>
              <td class="text-end">
                ${pnl
                  ? `<span class="badge ${badgeClass}">${(pnl>=0?'+':'') + pnl.toFixed(0)} (${rateStr})</span>`
                  : ''}
              </td>
              <td>${row.recommendType === 'yes'
                    ? '<span class="badge bg-primary">æ¨è–¦</span>'
                    : '<span class="badge bg-secondary">ä¸€èˆ¬</span>'}</td>
              <td>${row.createdAt ? new Date(row.createdAt).toLocaleString() : ''}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger"
                        onclick="deleteRow('${row._id}','${row.client}','${row.code}')">åˆªé™¤</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
      }

      if (viewMode === 'client') {
        if (!data.length) {
          clientContainer.innerHTML = '<div class="text-center text-muted">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>';
        } else {
          const groups = {};
          data.forEach(r => {
            const key = r.client || 'æœªå‘½åå®¢æˆ¶';
            if (!groups[key]) {
              groups[key] = { items: [], cost: 0, value: 0 };
            }
            const qty  = Number(r.quantity) || 0;
            const cost = Number(r.cost) || 0;
            const cur  = Number(r.currentPrice ?? r.cost) || 0;

            groups[key].items.push(r);
            groups[key].cost  += qty * cost;
            groups[key].value += qty * cur;
          });

          clientContainer.innerHTML = '';
          Object.keys(groups).sort().forEach(name => {
            const g = groups[name];
            const pnl  = g.value - g.cost;
            const rate = g.cost > 0 ? pnl / g.cost * 100 : 0;
            const rateStr = (rate >= 0 ? '+' : '') + rate.toFixed(2) + '%';
            const pnlClass = pnl >= 0 ? 'text-up' : 'text-down';

            const card = document.createElement('div');
            card.className = 'client-group-card';
            card.innerHTML = `
              <div class="client-group-header">
                <div>
                  <strong>${name}</strong>
                  <span class="ms-2 text-muted">å…± ${g.items.length} æª”</span>
                </div>
                <div class="${pnlClass} fw-semibold">
                  ${pnl >= 0 ? '+' : ''}${pnl.toFixed(0)} (${rateStr})
                </div>
              </div>
              <div class="client-group-body">
                <div class="table-responsive">
                  <table class="table table-sm mb-0 align-middle">
                    <thead>
                      <tr>
                        <th>è‚¡ç¥¨</th>
                        <th>ä»£ç¢¼</th>
                        <th class="text-end">æ•¸é‡</th>
                        <th class="text-end">æˆæœ¬</th>
                        <th class="text-end">å³æ™‚åƒ¹</th>
                        <th class="text-end">ä¼°ç®—å¸‚å€¼</th>
                        <th class="text-end">ç›ˆè™§</th>
                        <th>é¡å‹</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${g.items.map(r => {
                        const qty  = Number(r.quantity) || 0;
                        const cost = Number(r.cost) || 0;
                        const cur  = Number(r.currentPrice ?? r.cost) || 0;
                        const value = qty * cur;
                        const pnlItem = qty * (cur - cost);
                        const rateItem = cost > 0 ? (cur - cost) / cost * 100 : 0;
                        const badgeClass = pnlItem >= 0 ? 'badge-up' : 'badge-down';
                        const rateItemStr = (rateItem>=0?'+':'') + rateItem.toFixed(1) + '%';
                        return `
                          <tr>
                            <td>${r.stockName || ''}</td>
                            <td>${r.code || ''}</td>
                            <td class="text-end">${qty.toLocaleString('zh-TW')}</td>
                            <td class="text-end">${cost || ''}</td>
                            <td class="text-end">${cur || ''}</td>
                            <td class="text-end">${value ? value.toLocaleString('zh-TW',{maximumFractionDigits:0}) : ''}</td>
                            <td class="text-end">
                              ${pnlItem
                                ? `<span class="badge ${badgeClass}">${(pnlItem>=0?'+':'')+pnlItem.toFixed(0)} (${rateItemStr})</span>`
                                : ''}
                            </td>
                            <td>${r.recommendType === 'yes'
                                  ? '<span class="badge bg-primary">æ¨è–¦</span>'
                                  : '<span class="badge bg-secondary">ä¸€èˆ¬</span>'}</td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
            clientContainer.appendChild(card);
          });
        }
      }
    }

    function showClientDetail(row) {
      const body = document.getElementById('clientDetailBody');

      const qty  = Number(row.quantity) || 0;
      const cost = Number(row.cost) || 0;
      const cur  = Number(row.currentPrice ?? row.cost) || 0;
      const value = qty * cur;
      const pnl   = qty * (cur - cost);
      const rate  = cost > 0 ? (cur - cost) / cost * 100 : 0;

      const p = row.clientProfile || {};

      let html = `
        <div class="mb-3">
          <h6>å®¢æˆ¶æª”æ¡ˆ</h6>
          <table class="table table-sm">
            <tbody>
              <tr><th style="width:130px;">å®¢æˆ¶å§“å</th><td>${row.client || ''}</td></tr>
              <tr><th>æ€§åˆ¥</th><td>${p.gender || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>å¹´é½¡(æ­²)</th><td>${p.age || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>è‚¡é½¡</th><td>${p.experience || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>æ“ä½œæ–¹å¼</th><td>${p.style || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>èˆˆè¶£æ„›å¥½</th><td>${p.hobbies || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>å®¶åº­æƒ…æ³</th><td>${p.family || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>å‚™è¨»</th><td>${p.note || 'â€”'}</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mb-3">
          <h6>è‚¡ç¥¨è³‡è¨Š</h6>
          <table class="table table-sm">
            <tbody>
              <tr><th style="width:130px;">è‚¡ç¥¨åç¨±</th><td>${row.stockName || ''}</td></tr>
              <tr><th>è‚¡ç¥¨ä»£ç¢¼</th><td>${row.code || ''}</td></tr>
              <tr><th>æ˜¯å¦æ¨è–¦</th><td>${row.recommendType === 'yes' ? 'æ¨è–¦é£†è‚¡' : 'ä¸€èˆ¬'}</td></tr>
              <tr><th>æäº¤æ™‚é–“</th><td>${row.createdAt ? new Date(row.createdAt).toLocaleString() : ''}</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mb-1">
          <h6>æŒå€‰èˆ‡æç›Š</h6>
          <table class="table table-sm">
            <tbody>
              <tr><th style="width:130px;">æŒè‚¡æ•¸é‡</th><td>${qty.toLocaleString('zh-TW')}</td></tr>
              <tr><th>è²·å…¥æˆæœ¬</th><td>${cost}</td></tr>
              <tr><th>å³æ™‚è‚¡åƒ¹</th><td>${cur}</td></tr>
              <tr><th>ä¼°ç®—å¸‚å€¼</th><td>${value ? value.toLocaleString('zh-TW',{maximumFractionDigits:0}) : ''}</td></tr>
              <tr><th>ä¼°ç®—ç›ˆè™§</th><td>${pnl ? ((pnl>=0?'+':'') + pnl.toFixed(0)) : '0'}</td></tr>
              <tr><th>å ±é…¬ç‡</th><td>${cost>0 ? ((rate>=0?'+':'') + rate.toFixed(2) + '%') : '-'}</td></tr>
            </tbody>
          </table>
        </div>
      `;

      body.innerHTML = html;

      const modal = new bootstrap.Modal(document.getElementById('clientDetailModal'));
      modal.show();
    }

    async function deleteRow(id, client, code) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${client || ''} / ${code || ''} é€™ç­†æŒå€‰å—ï¼Ÿ`)) return;

      try {
        await fetch(`${API_BASE}/delete_position`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: 'admin_view',
            client,
            code
          })
        });
      } catch (e) {
        console.warn('åˆªé™¤ API å‘¼å«å¤±æ•—ï¼ˆå‰ç«¯ä»ç§»é™¤ï¼‰', e);
      }

      allData = allData.filter(row => row._id !== id);
      render();
    }

    function exportCSV() {
      const data = getFilteredAndSortedData();
      if (!data.length) {
        alert('ç›®å‰æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
        return;
      }

      let csv = 'å®¢æˆ¶å§“å,è‚¡ç¥¨åç¨±,ä»£ç¢¼,æŒè‚¡æ•¸,è²·å…¥åƒ¹,å³æ™‚åƒ¹,ä¼°ç®—å¸‚å€¼,ä¼°ç®—ç›ˆè™§,æ˜¯å¦æ¨è–¦,æäº¤æ™‚é–“\n';
      data.forEach(row => {
        const qty  = Number(row.quantity) || 0;
        const cost = Number(row.cost) || 0;
        const cur  = Number(row.currentPrice ?? row.cost) || 0;
        const value = qty * cur;
        const pnl   = qty * (cur - cost);

        csv += [
          row.client || '',
          row.stockName || '',
          row.code || '',
          qty,
          cost,
          cur,
          value.toFixed(0),
          pnl.toFixed(0),
          row.recommendType === 'yes' ? 'æ¨è–¦' : 'ä¸€èˆ¬',
          row.createdAt ? new Date(row.createdAt).toLocaleString() : ''
        ].join(',') + '\n';
      });

      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'æŒå€‰ç¸½è¡¨.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
