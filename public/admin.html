<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾Œå°ç®¡ç†ç³»çµ± - Stock Tracker</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f6f9; }
    .login-card {
      max-width: 400px;
      margin: 100px auto;
      padding: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .dashboard { display: none; padding: 20px; }
  </style>
</head>
<body>

  <!-- 1. ç™»éŒ„ä»‹é¢ -->
  <div id="loginSection" class="container">
    <div class="login-card">
      <h3 class="text-center mb-4">ç®¡ç†å“¡ç™»éŒ„</h3>

      <div class="mb-3">
        <label class="form-label">å¸³è™Ÿ</label>
        <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">å¯†ç¢¼</label>
        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="form-control">
      </div>

      <button onclick="handleLogin()" class="btn btn-primary w-100">ç™»éŒ„ç³»çµ±</button>
      <p id="loginError" class="text-danger mt-2 text-center" style="display:none;">å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤</p>
    </div>
  </div>

  <!-- 2. å„€è¡¨æ¿ï¼ˆç™»å…¥å¾Œé¡¯ç¤ºï¼‰ -->
  <div id="dashboardSection" class="dashboard container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>ğŸ“Š ç”¨æˆ¶æŒå€‰æ•¸æ“šç¸½è¦½</h2>
      <button onclick="logout()" class="btn btn-outline-danger">é€€å‡ºç™»éŒ„</button>
    </div>

    <div class="card">
      <div class="card-body">
        <button onclick="fetchData()" class="btn btn-success mb-3">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
        <div class="table-responsive">
          <table class="table table-hover table-striped">
            <thead class="table-dark">
              <tr>
                <th>å®¢æˆ¶å§“å</th>
                <th>è‚¡ç¥¨åç¨±</th>
                <th>ä»£ç¢¼</th>
                <th>æŒè‚¡æ•¸</th>
                <th>è²·å…¥åƒ¹</th>
                <th>æ­¢æåƒ¹</th>
                <th>æäº¤æ™‚é–“</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <!-- è³‡æ–™å‹•æ…‹æ’å…¥ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å¾Œç«¯ API æ ¹è·¯å¾‘ï¼ˆRenderï¼‰
    const API_BASE = '/api'; // åŒç¶²åŸŸï¼Œå¯«ç›¸å°è·¯å¾‘å³å¯

    // å¦‚æœå·²ç™»å…¥ï¼Œç›´æ¥é¡¯ç¤ºå„€è¡¨æ¿
    if (localStorage.getItem('adminToken')) {
      showDashboard();
    }

    // ç™»å…¥è™•ç†ï¼ˆå¸³è™Ÿã€å¯†ç¢¼å›ºå®šï¼šadmin / Qq112233.ï¼‰
    async function handleLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const errorEl = document.getElementById('loginError');

      errorEl.style.display = 'none';
      errorEl.textContent = '';

      try {
        const res = await fetch(`${API_BASE}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const result = await res.json();

        if (result.success) {
          localStorage.setItem('adminToken', result.token || 'admin-fixed-token');
          showDashboard();
        } else {
          errorEl.textContent = result.message || 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
          errorEl.style.display = 'block';
        }
      } catch (e) {
        errorEl.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        errorEl.style.display = 'block';
      }
    }

    function showDashboard() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'block';
      fetchData();
    }

    function logout() {
      localStorage.removeItem('adminToken');
      document.getElementById('dashboardSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    }

    // å–å¾—è³‡æ–™ï¼ˆæ ¹æ“šä½ åŸæœ¬çš„ API è·¯ç”±ç°¡åŒ–ç¤ºæ„ï¼‰
    async function fetchData() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '<tr><td colspan="8" class="text-center">è¼‰å…¥ä¸­...</td></tr>';

      try {
        const res = await fetch(`${API_BASE}/get_data`);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>';
          return;
        }

        tbody.innerHTML = '';
        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.client || ''}</td>
            <td>${row.stockName || ''}</td>
            <td>${row.code || ''}</td>
            <td>${row.quantity ?? ''}</td>
            <td>${row.cost ?? ''}</td>
            <td>${row.stopLoss ?? ''}</td>
            <td>${row.createdAt ? new Date(row.createdAt).toLocaleString() : ''}</td>
            <td><button class="btn btn-sm btn-outline-primary" disabled>æŸ¥çœ‹</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }
  </script>
</body>
</html>
