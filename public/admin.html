<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾Œå°ç®¡ç†ç³»çµ± - Stock Tracker</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f4f6f9;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .login-card {
      max-width: 400px;
      margin: 100px auto;
      padding: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .dashboard { display: none; padding: 20px; }

    .page-header {
      padding: 12px 24px;
      margin-bottom: 16px;
      border-radius: 10px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .stat-card {
      background: #ffffff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
      border: 1px solid #e5e7eb;
    }
    .stat-title { font-size: 13px; color: #6b7280; }
    .stat-value { font-size: 20px; font-weight: 700; }

    .badge-up { background:#fee2e2; color:#b91c1c; }
    .badge-down { background:#d1fae5; color:#065f46; }
    .text-up { color:#b91c1c; }
    .text-down { color:#059669; }

    .tab-pill.nav-pills .nav-link {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
    }
    .tab-pill.nav-pills .nav-link.active {
      background: #111827;
    }

    .search-input {
      max-width: 260px;
    }

    .client-group-card {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background:#fff;
      margin-bottom: 12px;
    }
    .client-group-header {
      padding: 10px 14px;
      border-bottom: 1px solid #e5e7eb;
      background:#f9fafb;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size: 14px;
    }
    .client-group-body { padding: 8px 12px; }

    .view-toggle .btn { font-size: 13px; }
  </style>
</head>
<body>

  <!-- 1. ç™»éŒ„ä»‹é¢ -->
  <div id="loginSection" class="container">
    <div class="login-card">
      <h3 class="text-center mb-4">ç®¡ç†å“¡ç™»éŒ„</h3>

      <div class="mb-3">
        <label class="form-label">å¸³è™Ÿ</label>
        <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">å¯†ç¢¼</label>
        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="form-control">
      </div>

      <button onclick="handleLogin()" class="btn btn-primary w-100">ç™»éŒ„ç³»çµ±</button>
      <p id="loginError" class="text-danger mt-2 text-center" style="display:none;">å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤</p>
    </div>
  </div>

  <!-- 2. å„€è¡¨æ¿ï¼ˆç™»å…¥å¾Œé¡¯ç¤ºï¼‰ -->
  <div id="dashboardSection" class="dashboard container-fluid">
    <!-- é ‚éƒ¨æ¢ -->
    <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h4 class="mb-1">ğŸ“Š ç”¨æˆ¶æŒå€‰æ•¸æ“šç¸½è¦½</h4>
        <small class="text-muted" id="lastFetchTime"></small>
      </div>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <input type="text" id="searchInput" class="form-control form-control-sm search-input"
               placeholder="æœå°‹è‚¡ç¥¨åç¨± / ä»£ç¢¼">

        <div class="btn-group btn-group-sm view-toggle" role="group" aria-label="View toggle">
          <button type="button" class="btn btn-outline-secondary active" id="btnViewTable"
                  onclick="setViewMode('table')">è¡¨æ ¼è¦–åœ–</button>
          <button type="button" class="btn btn-outline-secondary" id="btnViewClient"
                  onclick="setViewMode('client')">ä¾å®¢æˆ¶åˆ†çµ„</button>
        </div>

        <!-- è‡ªå‹•åˆ·æ–°é–‹é—œ -->
        <div class="form-check form-switch ms-1">
          <input class="form-check-input" type="checkbox" id="autoRefreshSwitch">
          <label class="form-check-label small" for="autoRefreshSwitch">è‡ªå‹•åˆ·æ–°(10ç§’)</label>
        </div>

        <button onclick="exportCSV()" class="btn btn-outline-secondary btn-sm">ğŸ“¥ åŒ¯å‡º CSV</button>
        <button onclick="fetchData()" class="btn btn-success btn-sm">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
        <button onclick="logout()" class="btn btn-outline-danger btn-sm">é€€å‡ºç™»éŒ„</button>
      </div>
    </div>

    <!-- æ•´é«”çµ±è¨ˆ -->
    <div class="row g-3 mb-3">
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">ç¸½æŒå€‰ç­†æ•¸</div>
          <div class="stat-value" id="statCount">-</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">ç¸½æŒè‚¡æ•¸é‡</div>
          <div class="stat-value" id="statQty">-</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">ç¸½æŠ•å…¥é‡‘é¡</div>
          <div class="stat-value" id="statCost">-</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">æ¨è–¦é£†è‚¡æª”æ•¸</div>
          <div class="stat-value" id="statRecCount">-</div>
        </div>
      </div>
    </div>

    <!-- tabï¼šæ¨è–¦ / éæ¨è–¦ -->
    <ul class="nav nav-pills mb-2 tab-pill" id="typeTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tabAll" data-bs-toggle="pill" type="button"
                onclick="setFilterType('all')">å…¨éƒ¨</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabRec" data-bs-toggle="pill" type="button"
                onclick="setFilterType('rec')">æ¨è–¦é£†è‚¡</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabNormal" data-bs-toggle="pill" type="button"
                onclick="setFilterType('normal')">éæ¨è–¦</button>
      </li>
    </ul>

    <!-- ä¸»å…§å®¹ -->
    <div class="row">
      <!-- å·¦ï¼šè¡¨æ ¼ / å®¢æˆ¶è¦–åœ– -->
      <div class="col-lg-9 mb-3">
        <div class="card">
          <div class="card-body">
            <!-- è¡¨æ ¼è¦–åœ– -->
            <div id="tableView">
              <div class="table-responsive">
                <table class="table table-hover table-striped align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th>å®¢æˆ¶å§“å</th>
                      <th>è‚¡ç¥¨åç¨±</th>
                      <th>ä»£ç¢¼</th>
                      <th class="text-end">æŒè‚¡æ•¸</th>
                      <th class="text-end">è²·å…¥åƒ¹</th>
                      <th class="text-end">å³æ™‚åƒ¹</th>
                      <th class="text-end">ä¼°ç®—å¸‚å€¼</th>
                      <th class="text-end">ä¼°ç®—ç›ˆè™§</th>
                      <th>æ˜¯å¦æ¨è–¦</th>
                      <th>æäº¤æ™‚é–“</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="tableBody">
                    <!-- è³‡æ–™å‹•æ…‹æ’å…¥ -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- å®¢æˆ¶åˆ†çµ„è¦–åœ– -->
            <div id="clientView" style="display:none;">
              <div id="clientGroupContainer">
                <!-- å®¢æˆ¶ç¾¤çµ„å‹•æ…‹æ’å…¥ -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ï¼šç¸½è¦½ -->
      <div class="col-lg-3 mb-3">
        <div class="stat-card mb-3">
          <h6 class="mb-2">âš–ï¸ æ•´é«”ç›ˆè™§æ¦‚æ³</h6>
          <div class="d-flex flex-column gap-1">
            <div class="d-flex justify-content-between">
              <span class="stat-title">ä¼°ç®—ç¸½å¸‚å€¼</span>
              <span id="statValue" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="stat-title">ä¼°ç®—ç¸½ç›ˆè™§</span>
              <span id="statPnl" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="stat-title">æ•´é«”å ±é…¬ç‡</span>
              <span id="statPnlRate" class="fw-semibold">-</span>
            </div>
          </div>
        </div>

        <div class="stat-card">
          <h6 class="mb-2">ğŸ’¡ å°æç¤º</h6>
          <small class="text-muted">
            â€§ å‹¾é¸ã€Œè‡ªå‹•åˆ·æ–°ã€å¾Œï¼Œæ¯ 10 ç§’æ›´æ–°ä¸€æ¬¡è‚¡åƒ¹èˆ‡æ”¶ç›Šç‡<br>
            â€§ æœå°‹æ¡†å¯è¼¸å…¥è‚¡ç¥¨åç¨±æˆ–ä»£ç¢¼<br>
            â€§ Tab å¯åˆ‡æ›ã€Œæ¨è–¦é£†è‚¡ã€èˆ‡ã€Œéæ¨è–¦ã€<br>
            â€§ çµ±è¨ˆç”¨ã€Œå³æ™‚åƒ¹ Ã— è‚¡æ•¸ã€ä¼°ç®—ï¼Œä¸å«æ‰‹çºŒè²»ã€ç¨…è²»
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = '/api';

    let allData = [];          // æŒå€‰ + ç¾åƒ¹
    let viewMode = 'table';    // 'table' or 'client'
    let filterType = 'all';    // 'all' | 'rec' | 'normal'
    let searchText = '';       // æœå°‹æ–‡å­—
    let autoRefreshTimer = null; // è‡ªå‹•åˆ·æ–°è¨ˆæ™‚å™¨

    // å·²ç™»å…¥å‰‡ç›´æ¥é€²å…¥å„€è¡¨æ¿
    if (localStorage.getItem('adminToken')) {
      showDashboard();
    }

    // ç™»å…¥
    async function handleLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const errorEl = document.getElementById('loginError');

      errorEl.style.display = 'none';
      errorEl.textContent = '';

      try {
        const res = await fetch(`${API_BASE}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const result = await res.json();

        if (result.success) {
          localStorage.setItem('adminToken', result.token || 'admin-fixed-token');
          showDashboard();
        } else {
          errorEl.textContent = result.message || 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
          errorEl.style.display = 'block';
        }
      } catch (e) {
        errorEl.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        errorEl.style.display = 'block';
      }
    }

    function showDashboard() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'block';
      fetchData();
    }

    function logout() {
      localStorage.removeItem('adminToken');
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
        document.getElementById('autoRefreshSwitch').checked = false;
      }
      document.getElementById('dashboardSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    }

    // è¦–åœ–æ¨¡å¼
    function setViewMode(mode) {
      viewMode = mode;
      document.getElementById('tableView').style.display = mode === 'table' ? 'block' : 'none';
      document.getElementById('clientView').style.display = mode === 'client' ? 'block' : 'none';

      document.getElementById('btnViewTable').classList.toggle('active', mode === 'table');
      document.getElementById('btnViewClient').classList.toggle('active', mode === 'client');

      render();
    }

    // æ¨è–¦ç¯©é¸
    function setFilterType(type) {
      filterType = type;
      document.getElementById('tabAll').classList.toggle('active', type === 'all');
      document.getElementById('tabRec').classList.toggle('active', type === 'rec');
      document.getElementById('tabNormal').classList.toggle('active', type === 'normal');
      render();
    }

    // æœå°‹æ¡†
    document.getElementById('searchInput').addEventListener('input', (e) => {
      searchText = e.target.value.trim().toLowerCase();
      render();
    });

    // è‡ªå‹•åˆ·æ–°é–‹é—œ
    document.getElementById('autoRefreshSwitch').addEventListener('change', (e) => {
      if (e.target.checked) {
        // ç«‹åˆ»æŠ“ä¸€æ¬¡
        fetchData();
        // æ¯ 10 ç§’è‡ªå‹•æ›´æ–°
        autoRefreshTimer = setInterval(fetchData, 10000);
      } else {
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
        }
      }
    });

    window.addEventListener('beforeunload', () => {
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    });

    // æŠ“è³‡æ–™ + å³æ™‚è‚¡åƒ¹
    async function fetchData() {
      const tbody = document.getElementById('tableBody');
      const clientContainer = document.getElementById('clientGroupContainer');
      tbody.innerHTML = '<tr><td colspan="11" class="text-center">è¼‰å…¥ä¸­...</td></tr>';
      clientContainer.innerHTML = '<div class="text-center text-muted">è¼‰å…¥ä¸­...</div>';

      try {
        // 1. æŠ“æŒå€‰è³‡æ–™
        const res = await fetch(`${API_BASE}/get_data`);
        const data = await res.json();
        const list = Array.isArray(data) ? data : [];

        let tempData = list.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        // 2. æŠ“è‚¡åƒ¹
        const codes = [...new Set(tempData.map(r => r.code).filter(Boolean))];

        if (codes.length > 0) {
          try {
            const priceRes = await fetch(`${API_BASE}/prices`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ codes })
            });
            const priceMap = await priceRes.json();  // e.g. { '2330': 610, ... }

            tempData = tempData.map(row => {
              const codeKey = String(row.code || '');
              const price = priceMap[codeKey];
              return { ...row, currentPrice: typeof price === 'number' ? price : undefined };
            });
          } catch (e) {
            console.warn('å–å¾—å³æ™‚åƒ¹æ ¼å¤±æ•—ï¼Œæ”¹ç”¨æˆæœ¬åƒ¹ç•¶ç¾åƒ¹', e);
          }
        }

        allData = tempData;

        document.getElementById('lastFetchTime').textContent =
          'æœ€å¾Œåˆ·æ–°ï¼š' + new Date().toLocaleString('zh-TW');

        render();
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">è¼‰å…¥å¤±æ•—</td></tr>';
        clientContainer.innerHTML = '<div class="text-center text-danger">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // æ¬„ä½éæ¿¾
    function getFilteredData() {
      return allData.filter(row => {
        if (filterType === 'rec' && row.recommendType !== 'yes') return false;
        if (filterType === 'normal' && row.recommendType === 'yes') return false;

        if (searchText) {
          const name = (row.stockName || '').toLowerCase();
          const code = (row.code || '').toLowerCase();
          if (!name.includes(searchText) && !code.includes(searchText)) return false;
        }
        return true;
      });
    }

    // çµ±è¨ˆ + é‡ç¹ªç•«é¢
    function render() {
      const data = getFilteredData();
      const tbody = document.getElementById('tableBody');
      const clientContainer = document.getElementById('clientGroupContainer');

      // ---- çµ±è¨ˆ ----
      let totalCount = data.length;
      let totalQty = 0;
      let totalCostAmount = 0;
      let totalValue = 0;
      let recCount = 0;

      data.forEach(row => {
        const qty  = Number(row.quantity) || 0;
        const cost = Number(row.cost) || 0;
        const cur  = Number(row.currentPrice ?? row.cost) || 0;

        totalQty        += qty;
        totalCostAmount += qty * cost;
        totalValue      += qty * cur;
        if (row.recommendType === 'yes') recCount++;
      });

      document.getElementById('statCount').textContent = totalCount;
      document.getElementById('statQty').textContent   = totalQty.toLocaleString('zh-TW');
      document.getElementById('statCost').textContent  = totalCostAmount.toLocaleString('zh-TW', { maximumFractionDigits: 0 });
      document.getElementById('statRecCount').textContent = recCount;

      document.getElementById('statValue').textContent = totalValue.toLocaleString('zh-TW', { maximumFractionDigits: 0 });

      const totalPnl = totalValue - totalCostAmount;
      const pnlEl = document.getElementById('statPnl');
      const rateEl = document.getElementById('statPnlRate');

      if (totalCostAmount > 0) {
        const pnlRate = totalPnl / totalCostAmount * 100;
        pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + totalPnl.toFixed(0);
        pnlEl.className = totalPnl >= 0 ? 'fw-semibold text-up' : 'fw-semibold text-down';

        rateEl.textContent = (pnlRate >= 0 ? '+' : '') + pnlRate.toFixed(2) + '%';
        rateEl.className = pnlRate >= 0 ? 'fw-semibold text-up' : 'fw-semibold text-down';
      } else {
        pnlEl.textContent = '-';
        pnlEl.className = 'fw-semibold';
        rateEl.textContent = '-';
        rateEl.className = 'fw-semibold';
      }

      // ---- è¡¨æ ¼è¦–åœ– ----
      if (viewMode === 'table') {
        if (!data.length) {
          tbody.innerHTML = '<tr><td colspan="11" class="text-center">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
        } else {
          tbody.innerHTML = '';
          data.forEach(row => {
            const qty  = Number(row.quantity) || 0;
            const cost = Number(row.cost) || 0;
            const cur  = Number(row.currentPrice ?? row.cost) || 0;
            const value = qty * cur;
            const pnl   = qty * (cur - cost);
            const rate  = cost > 0 ? (cur - cost) / cost * 100 : 0;

            const badgeClass = pnl >= 0 ? 'badge-up' : 'badge-down';
            const rateStr    = (rate >= 0 ? '+' : '') + rate.toFixed(2) + '%';

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row.client || ''}</td>
              <td>${row.stockName || ''}</td>
              <td>${row.code || ''}</td>
              <td class="text-end">${qty.toLocaleString('zh-TW')}</td>
              <td class="text-end">${cost || ''}</td>
              <td class="text-end">${cur || ''}</td>
              <td class="text-end">${value ? value.toLocaleString('zh-TW', { maximumFractionDigits: 0 }) : ''}</td>
              <td class="text-end">
                ${pnl
                  ? `<span class="badge ${badgeClass}">${(pnl>=0?'+':'') + pnl.toFixed(0)} (${rateStr})</span>`
                  : ''}
              </td>
              <td>${row.recommendType === 'yes'
                    ? '<span class="badge bg-primary">æ¨è–¦</span>'
                    : '<span class="badge bg-secondary">ä¸€èˆ¬</span>'}</td>
              <td>${row.createdAt ? new Date(row.createdAt).toLocaleString() : ''}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger"
                        onclick="deleteRow('${row._id}','${row.client}','${row.code}')">åˆªé™¤</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
      }

      // ---- å®¢æˆ¶åˆ†çµ„è¦–åœ– ----
      if (viewMode === 'client') {
        if (!data.length) {
          clientContainer.innerHTML = '<div class="text-center text-muted">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>';
        } else {
          const groups = {};
          data.forEach(r => {
            const key = r.client || 'æœªå‘½åå®¢æˆ¶';
            if (!groups[key]) {
              groups[key] = { items: [], cost: 0, value: 0 };
            }
            const qty  = Number(r.quantity) || 0;
            const cost = Number(r.cost) || 0;
            const cur  = Number(r.currentPrice ?? r.cost) || 0;

            groups[key].items.push(r);
            groups[key].cost  += qty * cost;
            groups[key].value += qty * cur;
          });

          clientContainer.innerHTML = '';
          Object.keys(groups).sort().forEach(name => {
            const g = groups[name];
            const pnl  = g.value - g.cost;
            const rate = g.cost > 0 ? pnl / g.cost * 100 : 0;
            const rateStr = (rate >= 0 ? '+' : '') + rate.toFixed(2) + '%';
            const pnlClass = pnl >= 0 ? 'text-up' : 'text-down';

            const card = document.createElement('div');
            card.className = 'client-group-card';
            card.innerHTML = `
              <div class="client-group-header">
                <div>
                  <strong>${name}</strong>
                  <span class="ms-2 text-muted">å…± ${g.items.length} æª”</span>
                </div>
                <div class="${pnlClass} fw-semibold">
                  ${pnl >= 0 ? '+' : ''}${pnl.toFixed(0)} (${rateStr})
                </div>
              </div>
              <div class="client-group-body">
                <div class="table-responsive">
                  <table class="table table-sm mb-0 align-middle">
                    <thead>
                      <tr>
                        <th>è‚¡ç¥¨</th>
                        <th>ä»£ç¢¼</th>
                        <th class="text-end">æ•¸é‡</th>
                        <th class="text-end">æˆæœ¬</th>
                        <th class="text-end">å³æ™‚åƒ¹</th>
                        <th class="text-end">ä¼°ç®—å¸‚å€¼</th>
                        <th class="text-end">ç›ˆè™§</th>
                        <th>é¡å‹</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${g.items.map(r => {
                        const qty  = Number(r.quantity) || 0;
                        const cost = Number(r.cost) || 0;
                        const cur  = Number(r.currentPrice ?? r.cost) || 0;
                        const value = qty * cur;
                        const pnlItem = qty * (cur - cost);
                        const rateItem = cost > 0 ? (cur - cost) / cost * 100 : 0;
                        const badgeClass = pnlItem >= 0 ? 'badge-up' : 'badge-down';
                        const rateItemStr = (rateItem>=0?'+':'') + rateItem.toFixed(1) + '%';
                        return `
                          <tr>
                            <td>${r.stockName || ''}</td>
                            <td>${r.code || ''}</td>
                            <td class="text-end">${qty.toLocaleString('zh-TW')}</td>
                            <td class="text-end">${cost || ''}</td>
                            <td class="text-end">${cur || ''}</td>
                            <td class="text-end">${value ? value.toLocaleString('zh-TW',{maximumFractionDigits:0}) : ''}</td>
                            <td class="text-end">
                              ${pnlItem
                                ? `<span class="badge ${badgeClass}">${(pnlItem>=0?'+':'')+pnlItem.toFixed(0)} (${rateItemStr})</span>`
                                : ''}
                            </td>
                            <td>${r.recommendType === 'yes'
                                  ? '<span class="badge bg-primary">æ¨è–¦</span>'
                                  : '<span class="badge bg-secondary">ä¸€èˆ¬</span>'}</td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
            clientContainer.appendChild(card);
          });
        }
      }
    }

    // åˆªé™¤
    async function deleteRow(id, client, code) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${client || ''} / ${code || ''} é€™ç­†æŒå€‰å—ï¼Ÿ`)) return;

      try {
        await fetch(`${API_BASE}/delete_position`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: 'admin_view', // å¦‚å¾Œç«¯éœ€è¦ userIdï¼Œå¯åœ¨å¾Œç«¯ç‰¹åˆ¥è™•ç†
            client,
            code
          })
        });
      } catch (e) {
        console.warn('åˆªé™¤ API å‘¼å«å¤±æ•—ï¼ˆå‰ç«¯ä»ç§»é™¤ï¼‰', e);
      }

      allData = allData.filter(row => row._id !== id);
      render();
    }

    // åŒ¯å‡º CSV
    function exportCSV() {
      const data = getFilteredData();
      if (!data.length) {
        alert('ç›®å‰æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
        return;
      }

      let csv = 'å®¢æˆ¶å§“å,è‚¡ç¥¨åç¨±,ä»£ç¢¼,æŒè‚¡æ•¸,è²·å…¥åƒ¹,å³æ™‚åƒ¹,ä¼°ç®—å¸‚å€¼,ä¼°ç®—ç›ˆè™§,æ˜¯å¦æ¨è–¦,æäº¤æ™‚é–“\n';
      data.forEach(row => {
        const qty  = Number(row.quantity) || 0;
        const cost = Number(row.cost) || 0;
        const cur  = Number(row.currentPrice ?? row.cost) || 0;
        const value = qty * cur;
        const pnl   = qty * (cur - cost);

        csv += [
          row.client || '',
          row.stockName || '',
          row.code || '',
          qty,
          cost,
          cur,
          value.toFixed(0),
          pnl.toFixed(0),
          row.recommendType === 'yes' ? 'æ¨è–¦' : 'ä¸€èˆ¬',
          row.createdAt ? new Date(row.createdAt).toLocaleString() : ''
        ].join(',') + '\n';
      });

      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'æŒå€‰ç¸½è¡¨.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
