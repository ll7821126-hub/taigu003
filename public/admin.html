<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾Œå°ç®¡ç†ç³»çµ± - Stock Tracker</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f3f4f6;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #111827;
    }

    /* ç™»å…¥å¡ç‰‡ */
    .login-card {
      max-width: 400px;
      margin: 120px auto;
      padding: 32px 28px;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(15,23,42,0.18);
      border: 1px solid #e5e7eb;
    }
    .login-card h3 {font-weight:800;color:#111827;}
    .login-card .form-label{font-size:13px;color:#6b7280;}
    .login-card .form-control{
      border-radius:999px;
      font-size:14px;
    }
    .login-card .btn-primary{
      border-radius:999px;
      font-weight:700;
    }

    .dashboard { display: none; padding: 18px; }

    /* é ‚éƒ¨æ¢ */
    .page-header {
      padding: 14px 22px;
      margin-bottom: 14px;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 10px 25px rgba(15,23,42,0.08);
      border: 1px solid #e5e7eb;
    }
    .page-title {
      font-size: 20px;
      font-weight: 800;
      display:flex;
      align-items:center;
      gap:10px;
      color:#111827;
    }
    .page-subtitle {
      font-size: 12px;
      color: #6b7280;
    }
    .pill {
      padding:4px 10px;
      border-radius:999px;
      background:#eff6ff;
      border:1px solid #bfdbfe;
      font-size:11px;
      color:#1d4ed8;
    }
    .header-right .btn {
      border-radius:999px;
      font-size:12px;
      padding:6px 14px;
    }
    .btn-icon{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    /* çµ±è¨ˆå¡ç‰‡ */
    .stat-card {
      background: #ffffff;
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 8px 18px rgba(15,23,42,0.05);
      border: 1px solid #e5e7eb;
    }
    .stat-title { font-size:12px; color:#6b7280; }
    .stat-value { font-size:20px; font-weight:800; color:#111827;}

    .badge-up { background:#dcfce7; color:#166534; }
    .badge-down { background:#fee2e2; color:#b91c1c; }
    .text-up { color:#16a34a; }
    .text-down { color:#b91c1c; }

    /* Tab */
    .tab-pill.nav-pills .nav-link {
      border-radius: 999px;
      padding: 5px 14px;
      font-size: 12px;
      color:#6b7280;
      border:1px solid transparent;
    }
    .tab-pill.nav-pills .nav-link:hover{
      background:#f3f4f6;
    }
    .tab-pill.nav-pills .nav-link.active {
      background: #111827;
      color:#f9fafb;
      border-color:#111827;
    }

    /* ä¸»å¡ç‰‡ï¼ˆè¡¨æ ¼ï¼‰ */
    .card-main {
      background: #ffffff;
      border-radius:16px;
      box-shadow: 0 12px 28px rgba(15,23,42,0.06);
      border: 1px solid #e5e7eb;
    }

    /* æœå°‹ + æ’åº */
    .toolbar-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:10px;
    }
    .toolbar-left{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .toolbar-right{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .mini-label{
      font-size:11px;
      color:#6b7280;
      margin-right:4px;
    }
    .search-input { max-width: 260px; }

    .form-select, .form-control{
      font-size:12px;
    }

    /* è¡¨æ ¼ */
    .table-dark {
      background:#111827;
      color:#e5e7eb;
    }
    .table-dark th{
      border-bottom-color:#1f2937!important;
      font-size:11px;
      letter-spacing:0.03em;
    }
    tbody td{
      border-bottom:1px solid #e5e7eb!important;
      font-size:12px;
      color:#374151;
    }
    .table-hover tbody tr:hover{
      background-color:#f9fafb;
    }

    /* å®¢æˆ¶å§“åå¯é»æ“Š */
    .client-link {
      cursor: pointer;
      color: #2563eb;
      text-decoration: underline;
      font-weight:600;
    }
    .client-link:hover {
      color: #1d4ed8;
    }

    .small-muted{font-size:11px;color:#6b7280;}

    /* Modal */
    .modal-content{
      border-radius:16px;
      background:#ffffff;
      color:#111827;
    }
    .modal-title{font-weight:800;}

    /* å°æŒ‰éˆ• */
    .btn-outline-secondary.btn-sm,
    .btn-success.btn-sm,
    .btn-outline-danger.btn-sm{
      border-radius:999px;
      font-size:11px;
      padding:5px 12px;
    }

    .tag-pill{
      border-radius:999px;
      font-size:11px;
      padding:2px 8px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      margin-right:4px;
    }

    /* ====== Modal å…§çš„æŒå€‰å¡ç‰‡ï¼ˆå‰ç«¯é¢¨æ ¼ï¼‰ ====== */
    .client-summary-card {
      border-radius: 12px;
      padding: 10px 14px;
      background: #ecfdf5;
      border: 1px solid #bbf7d0;
      color: #065f46;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .client-summary-card .title {
      font-weight: 700;
      margin-bottom: 4px;
    }
    .client-summary-card .pnl-positive {
      color: #16a34a;
      font-weight: 700;
    }
    .client-summary-card .pnl-negative {
      color: #b91c1c;
      font-weight: 700;
    }

    .client-holdings-wrapper {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .holding-row-card {
      display: grid;
      grid-template-columns: 1.6fr 0.8fr 0.9fr 0.9fr 0.9fr 1fr 1fr 0.9fr;
      gap: 8px;
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      align-items: center;
      font-size: 12px;
    }
    .holding-row-card.header {
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      background: #f9fafb;
    }
    .holding-row-card.body {
      background: #ffffff;
    }
    .holding-row-card.body:nth-child(even) {
      background: #f9fafb;
    }

    .badge-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge-tag.rec {
      background: #eff6ff;
      color: #1d4ed8;
    }
    .badge-tag.normal {
      background: #f3f4f6;
      color: #4b5563;
    }

    .badge-pnl-up {
      background: #dcfce7;
      color: #166534;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-pnl-down {
      background: #fee2e2;
      color: #b91c1c;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
    }

    .holding-actions {
      display:flex;
      gap:4px;
      justify-content:flex-end;
    }
    .btn-icon-mini{
      border-radius:999px;
      font-size:10px;
      padding:3px 7px;
    }
  </style>
</head>
<body>

  <!-- ç™»éŒ„ä»‹é¢ -->
  <div id="loginSection" class="container">
    <div class="login-card">
      <h3 class="text-center mb-4">å¾Œå°ç®¡ç†ç™»å…¥</h3>

      <div class="mb-3">
        <label class="form-label">å¸³è™Ÿ</label>
        <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">å¯†ç¢¼</label>
        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="form-control">
      </div>

      <button onclick="handleLogin()" class="btn btn-primary w-100 mt-2">ç™»å…¥ç³»çµ±</button>
      <p id="loginError" class="text-danger mt-3 text-center" style="display:none;">å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤</p>
    </div>
  </div>

  <!-- å„€è¡¨æ¿ -->
  <div id="dashboardSection" class="dashboard container-fluid">
    <!-- é ‚éƒ¨æ¢ -->
    <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <div class="page-title">
          å®¢æˆ¶æŒå€‰ç›£æ§é¢æ¿
          <span class="pill">Admin Console</span>
        </div>
        <div class="page-subtitle">
          ä»¥ã€Œå®¢æˆ¶ã€ç‚ºä¸­å¿ƒï¼Œå½™ç¸½æª¢è¦–æ‰€æœ‰æŒè‚¡èˆ‡é¢¨éšªç‹€æ…‹
        </div>
        <div id="lastFetchTime" class="small-muted mt-1"></div>
      </div>

      <div class="header-right d-flex align-items-center gap-2 flex-wrap">
        <div class="form-check form-switch text-nowrap">
          <input class="form-check-input" type="checkbox" id="autoRefreshSwitch">
          <label class="form-check-label small" for="autoRefreshSwitch">è‡ªå‹•åˆ·æ–° (10 ç§’)</label>
        </div>
        <button onclick="exportCSV()" class="btn btn-outline-secondary btn-sm btn-icon">
          <span>ğŸ“¥ åŒ¯å‡º CSV</span>
        </button>
        <button onclick="fetchData()" class="btn btn-success btn-sm btn-icon">
          <span>ğŸ”„ ç«‹å³åˆ·æ–°</span>
        </button>
        <button onclick="logout()" class="btn btn-outline-danger btn-sm btn-icon">
          <span>ç™»å‡º</span>
        </button>
      </div>
    </div>

    <!-- æ•´é«”çµ±è¨ˆ -->
    <div class="row g-3 mb-3">
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">å®¢æˆ¶ç¸½æ•¸</div>
          <div class="stat-value" id="statClientCount">-</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">ç¸½æŒå€‰ç­†æ•¸</div>
          <div class="stat-value" id="statHoldingCount">-</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">ç¸½æŒè‚¡æ•¸é‡</div>
          <div class="stat-value" id="statQty">-</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-title">æ¨è–¦é£†è‚¡å®¢æˆ¶æ•¸</div>
          <div class="stat-value" id="statRecClientCount">-</div>
        </div>
      </div>
    </div>

    <!-- é¡å‹ç¯©é¸ -->
    <ul class="nav nav-pills mb-2 tab-pill" id="typeTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tabAll" data-bs-toggle="pill" type="button"
                onclick="setFilterType('all')">å…¨éƒ¨</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabRec" data-bs-toggle="pill" type="button"
                onclick="setFilterType('rec')">æ¨è–¦é£†è‚¡</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabRisk" data-bs-toggle="pill" type="button"
                onclick="setFilterType('loss')">è™§ææŒå€‰</button>
      </li>
    </ul>

    <!-- ä¸»å…§å®¹ -->
    <div class="row">
      <div class="col-lg-9 mb-3">
        <div class="card card-main">
          <div class="card-body">

            <!-- å·¥å…·åˆ—ï¼šæœå°‹ + æ’åº -->
            <div class="toolbar-row">
              <div class="toolbar-left">
                <span class="mini-label">æœå°‹å®¢æˆ¶ / è‚¡ç¥¨</span>
                <input type="text" id="searchInput"
                       class="form-control form-control-sm search-input"
                       placeholder="è¼¸å…¥å®¢æˆ¶å§“åæˆ–è‚¡ç¥¨åç¨±/ä»£ç¢¼">
              </div>
              <div class="toolbar-right">
                <span class="mini-label">æ’åº</span>
                <select id="sortSelect" class="form-select form-select-sm" style="min-width: 210px;">
                  <option value="client_asc">æŒ‰å®¢æˆ¶å§“å</option>
                  <option value="pnl_desc">æŒ‰ç›ˆè™§ï¼ˆé«˜ â†’ ä½ï¼‰</option>
                  <option value="pnl_asc">æŒ‰ç›ˆè™§ï¼ˆä½ â†’ é«˜ï¼‰</option>
                  <option value="value_desc">æŒ‰å¸‚å€¼ï¼ˆå¤§ â†’ å°ï¼‰</option>
                  <option value="value_asc">æŒ‰å¸‚å€¼ï¼ˆå° â†’ å¤§ï¼‰</option>
                  <option value="time_desc">æŒ‰æœ€æ–°æ™‚é–“</option>
                </select>
              </div>
            </div>

            <div class="small-muted mb-2">
              æ¯åˆ—ä»£è¡¨ã€Œä¸€ç­†æŒå€‰ã€ï¼ŒåŒä¸€å®¢æˆ¶å¤šæª”è‚¡ç¥¨æœƒåˆ†è¡Œé¡¯ç¤ºï¼›é»å®¢æˆ¶å§“åå¯çœ‹è©²å®¢æˆ¶çš„å®Œæ•´æª”æ¡ˆèˆ‡å…¨éƒ¨æŒè‚¡ã€‚
            </div>

            <!-- è¡¨æ ¼è¦–åœ–ï¼šä¸€ç­†æŒå€‰ä¸€åˆ— -->
            <div id="tableView">
              <div class="table-responsive">
                <table class="table table-hover table-striped align-middle mb-0">
                  <thead class="table-dark">
                    <tr>
                      <th style="width:14%;">å®¢æˆ¶å§“å</th>
                      <th style="width:18%;">è‚¡ç¥¨</th>
                      <th style="width:8%;">ä»£ç¢¼</th>
                      <th class="text-end" style="width:10%;">æ•¸é‡</th>
                      <th class="text-end" style="width:10%;">æˆæœ¬åƒ¹</th>
                      <th class="text-end" style="width:10%;">å³æ™‚åƒ¹</th>
                      <th class="text-end" style="width:12%;">å¸‚å€¼</th>
                      <th class="text-end" style="width:10%;">ç›ˆè™§</th>
                      <th class="text-end" style="width:8%;">å ±é…¬ç‡</th>
                      <th style="width:10%;">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="tableBody"></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- å³å´ç¸½è¦½ -->
      <div class="col-lg-3 mb-3">
        <div class="stat-card mb-3">
          <h6 class="mb-2">âš–ï¸ ç›®å‰æ•´é«”ç›ˆè™§</h6>
          <div class="d-flex flex-column gap-1">
            <div class="d-flex justify-content-between">
              <span class="stat-title">ä¼°ç®—ç¸½å¸‚å€¼</span>
              <span id="statValue" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="stat-title">ä¼°ç®—ç¸½ç›ˆè™§</span>
              <span id="statPnl" class="fw-semibold">-</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="stat-title">æ•´é«”å ±é…¬ç‡</span>
              <span id="statPnlRate" class="fw-semibold">-</span>
            </div>
          </div>
        </div>

        <div class="stat-card">
          <h6 class="mb-2">ğŸ’¡ ä½¿ç”¨æç¤º</h6>
          <small class="small-muted">
            â€§ åˆ—è¡¨ä¸€è¡Œä¸€ç­†æŒå€‰ï¼Œæ–¹ä¾¿æ¯”å°èˆ‡åˆªé™¤<br>
            â€§ é»ã€Œå®¢æˆ¶å§“åã€å¯æŸ¥çœ‹è©²å®¢æˆ¶å®Œæ•´æª”æ¡ˆèˆ‡æ‰€æœ‰æŒè‚¡<br>
            â€§ ç›ˆè™§é‡‘é¡ä»¥ç´…ç¶ é¡è‰²é¡¯ç¤ºï¼Œç¶ è‰²ä»£è¡¨ç²åˆ©ã€ç´…è‰²ä»£è¡¨è™§æ
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- å®¢æˆ¶è©³ç´°è³‡è¨Šå½ˆçª— -->
  <div class="modal fade" id="clientDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">å®¢æˆ¶è©³ç´°è³‡è¨Š</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
        </div>
        <div class="modal-body">
          <div id="clientDetailBody"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = '/api';

    let allHoldings = [];   // å¾Œç«¯åŸå§‹æ¯ç­†æŒå€‰
    let groupByClient = []; // ä¾å®¢æˆ¶åˆä½µï¼ˆçµ¦ Modal & çµ±è¨ˆç”¨ï¼‰
    let filterType = 'all';
    let searchText = '';
    let sortMode = 'client_asc';
    let autoRefreshTimer = null;

    // è‹¥å·²æœ‰ç™»å…¥ tokenï¼Œç›´æ¥é¡¯ç¤ºå¾Œå°
    if (localStorage.getItem('adminToken')) {
      showDashboard();
    }

    // ---------------- ç™»å…¥ / ç™»å‡º ----------------
    async function handleLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const errorEl = document.getElementById('loginError');

      errorEl.style.display = 'none';
      errorEl.textContent = '';

      try {
        const res = await fetch(`${API_BASE}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const result = await res.json();

        if (result.success) {
          localStorage.setItem('adminToken', result.token || 'admin-fixed-token');
          showDashboard();
        } else {
          errorEl.textContent = result.message || 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
          errorEl.style.display = 'block';
        }
      } catch (e) {
        errorEl.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        errorEl.style.display = 'block';
      }
    }

    function showDashboard() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'block';
      fetchData();
    }

    function logout() {
      localStorage.removeItem('adminToken');
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
        document.getElementById('autoRefreshSwitch').checked = false;
      }
      document.getElementById('dashboardSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    }

    // ---------------- ç¯©é¸ / æœå°‹ / æ’åº ----------------
    function setFilterType(type) {
      filterType = type;
      document.getElementById('tabAll').classList.toggle('active', type === 'all');
      document.getElementById('tabRec').classList.toggle('active', type === 'rec');
      document.getElementById('tabRisk').classList.toggle('active', type === 'loss');
      render();
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
      searchText = e.target.value.trim().toLowerCase();
      render();
    });

    document.getElementById('sortSelect').addEventListener('change', (e) => {
      sortMode = e.target.value;
      render();
    });

    document.getElementById('autoRefreshSwitch').addEventListener('change', (e) => {
      if (e.target.checked) {
        fetchData();
        autoRefreshTimer = setInterval(fetchData, 10000);
      } else {
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
        }
      }
    });

    window.addEventListener('beforeunload', () => {
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    });

    // ---------------- å–å¾—è³‡æ–™ + å³æ™‚åƒ¹ ----------------
    async function fetchData() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>';

      try {
        const res = await fetch(`${API_BASE}/get_data`);
        const data = await res.json();
        const list = Array.isArray(data) ? data : [];

        allHoldings = list;

        // è’é›†æ‰€æœ‰è‚¡ç¥¨ä»£ç¢¼ï¼ŒæŸ¥å³æ™‚åƒ¹
        const codes = [...new Set(allHoldings.map(r => r.code).filter(Boolean))];
        if (codes.length > 0) {
          try {
            const priceRes = await fetch(`${API_BASE}/prices`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ codes })
            });
            const priceMap = await priceRes.json();
            allHoldings = allHoldings.map(row => {
              const codeKey = String(row.code || '');
              const price = priceMap[codeKey];
              return { ...row, currentPrice: typeof price === 'number' ? price : undefined };
            });
          } catch (e) {
            console.warn('å–å¾—å³æ™‚åƒ¹æ ¼å¤±æ•—ï¼Œæ”¹ç”¨æˆæœ¬åƒ¹ç•¶ç¾åƒ¹', e);
          }
        }

        document.getElementById('lastFetchTime').textContent =
          'æœ€å¾Œåˆ·æ–°ï¼š' + new Date().toLocaleString('zh-TW');

        buildClientGroups();
        render();
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }

    // ---------------- ä¾å®¢æˆ¶åˆä½µï¼ˆçµ¦ Modal & çµ±è¨ˆï¼‰ ----------------
    function buildClientGroups() {
      const map = {};

      allHoldings.forEach(row => {
        const client = row.client || 'æœªå‘½åå®¢æˆ¶';
        const qty  = Number(row.quantity) || 0;
        const cost = Number(row.cost) || 0;
        const cur  = Number(row.currentPrice ?? row.cost) || 0;
        const value = qty * cur;

        if (!map[client]) {
          map[client] = {
            client,
            holdings: [],
            totalQty: 0,
            totalCost: 0,
            totalValue: 0,
            hasRecommend: false
          };
        }
        map[client].holdings.push(row);
        map[client].totalQty += qty;
        map[client].totalCost += qty * cost;
        map[client].totalValue += value;
        if (row.recommendType === 'yes') map[client].hasRecommend = true;
      });

      groupByClient = Object.values(map);
    }

    // ---------------- å–å¾—åˆ—è¡¨ï¼ˆå–®ç­†æŒå€‰ï¼‰ç¶“ç¯©é¸ / æ’åº ----------------
    function getFilteredAndSortedRows() {
      let rows = [...allHoldings];

      // æœå°‹
      if (searchText) {
        rows = rows.filter(r => {
          const client = (r.client || '').toLowerCase();
          const name = (r.stockName || '').toLowerCase();
          const code = (r.code || '').toLowerCase();
          return client.includes(searchText) || name.includes(searchText) || code.includes(searchText);
        });
      }

      // é¡å‹ç¯©é¸
      rows = rows.filter(r => {
        const qty  = Number(r.quantity) || 0;
        const cost = Number(r.cost) || 0;
        const cur  = Number(r.currentPrice ?? r.cost) || 0;
        const pnl  = qty * (cur - cost);

        if (filterType === 'rec') {
          return r.recommendType === 'yes';
        }
        if (filterType === 'loss') {
          return pnl < 0;
        }
        return true;
      });

      // æ’åº
      rows.sort((a, b) => {
        const qtyA = Number(a.quantity) || 0;
        const costA = Number(a.cost) || 0;
        const curA = Number(a.currentPrice ?? a.cost) || 0;
        const valueA = qtyA * curA;
        const pnlA = qtyA * (curA - costA);

        const qtyB = Number(b.quantity) || 0;
        const costB = Number(b.cost) || 0;
        const curB = Number(b.currentPrice ?? b.cost) || 0;
        const valueB = qtyB * curB;
        const pnlB = qtyB * (curB - costB);

        if (sortMode === 'client_asc') {
          return (a.client || '').localeCompare(b.client || '');
        }
        if (sortMode === 'pnl_desc') return pnlB - pnlA;
        if (sortMode === 'pnl_asc')  return pnlA - pnlB;
        if (sortMode === 'value_desc') return valueB - valueA;
        if (sortMode === 'value_asc')  return valueA - valueB;
        if (sortMode === 'time_desc') {
          return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        }
        return 0;
      });

      return rows;
    }

    // ---------------- ç•«é¢æ¸²æŸ“ ----------------
    function render() {
      const rows = getFilteredAndSortedRows();
      const tbody = document.getElementById('tableBody');

      // æ•´é«”çµ±è¨ˆ
      let clientSet = new Set();
      let holdingCount = allHoldings.length;
      let totalQty = 0;
      let totalCost = 0;
      let totalValue = 0;
      let recClientSet = new Set();

      allHoldings.forEach(r => {
        const client = r.client || 'æœªå‘½åå®¢æˆ¶';
        clientSet.add(client);
        const qty  = Number(r.quantity) || 0;
        const cost = Number(r.cost) || 0;
        const cur  = Number(r.currentPrice ?? r.cost) || 0;
        const value = qty * cur;
        totalQty += qty;
        totalCost += qty * cost;
        totalValue += value;
        if (r.recommendType === 'yes') recClientSet.add(client);
      });

      document.getElementById('statClientCount').textContent = clientSet.size;
      document.getElementById('statHoldingCount').textContent = holdingCount;
      document.getElementById('statQty').textContent = totalQty.toLocaleString('zh-TW');
      document.getElementById('statRecClientCount').textContent = recClientSet.size;
      document.getElementById('statValue').textContent =
        totalValue.toLocaleString('zh-TW', { maximumFractionDigits: 0 });

      const totalPnl = totalValue - totalCost;
      const pnlEl = document.getElementById('statPnl');
      const rateEl = document.getElementById('statPnlRate');

      if (totalCost > 0) {
        const pnlRate = totalPnl / totalCost * 100;
        pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + totalPnl.toFixed(0);
        pnlEl.className = 'fw-semibold ' + (totalPnl >= 0 ? 'text-up' : 'text-down');

        rateEl.textContent = (pnlRate >= 0 ? '+' : '') + pnlRate.toFixed(2) + '%';
        rateEl.className = 'fw-semibold ' + (pnlRate >= 0 ? 'text-up' : 'text-down');
      } else {
        pnlEl.textContent = '-';
        pnlEl.className = 'fw-semibold';
        rateEl.textContent = '-';
        rateEl.className = 'fw-semibold';
      }

      // åˆ—è¡¨
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æŒå€‰</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      rows.forEach(r => {
        const qty  = Number(r.quantity) || 0;
        const cost = Number(r.cost) || 0;
        const cur  = Number(r.currentPrice ?? r.cost) || 0;
        const value = qty * cur;
        const pnl   = qty * (cur - cost);
        const rate  = cost > 0 ? (cur - cost) / cost * 100 : 0;
        const pnlClass = pnl >= 0 ? 'text-up' : 'text-down';
        const rateStr = cost > 0 ? ((rate>=0?'+':'')+rate.toFixed(2)+'%') : '-';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <span class="client-link" onclick="showClientDetail('${(r.client || 'æœªå‘½åå®¢æˆ¶').replace(/'/g,"&#39;")}')">
              ${r.client || 'æœªå‘½åå®¢æˆ¶'}
            </span>
          </td>
          <td>${r.stockName || ''}</td>
          <td>${r.code || ''}</td>
          <td class="text-end">${qty.toLocaleString('zh-TW')}</td>
          <td class="text-end">${cost || ''}</td>
          <td class="text-end">${cur || ''}</td>
          <td class="text-end">${value ? value.toLocaleString('zh-TW',{maximumFractionDigits:0}) : ''}</td>
          <td class="text-end ${pnlClass}">
            ${(pnl>=0?'+':'') + pnl.toFixed(0)}
          </td>
          <td class="text-end ${pnlClass}">${rateStr}</td>
          <td>
            <button class="btn btn-outline-danger btn-sm btn-icon-mini"
                    onclick="deleteHolding('${r._id}')">
              åˆªé™¤
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ---------------- å®¢æˆ¶è©³ç´° Modal ----------------
    function showClientDetail(clientName) {
      const body = document.getElementById('clientDetailBody');
      const clientGroup = groupByClient.find(g => g.client === clientName);
      if (!clientGroup) return;

      // åˆä½µå®¢æˆ¶æª”æ¡ˆ
      const sameRows = clientGroup.holdings.filter(r => r.clientProfile);
      const mergedProfile = sameRows.reduce((acc, r) => {
        const p = r.clientProfile || {};
        return {
          gender:     acc.gender     || p.gender     || '',
          age:        acc.age        || p.age        || '',
          experience: acc.experience || p.experience || '',
          style:      acc.style      || p.style      || '',
          hobbies:    acc.hobbies    || p.hobbies    || '',
          family:     acc.family     || p.family     || '',
          note:       acc.note       || p.note       || ''
        };
      }, {});

      const p = mergedProfile;

      const profileHtml = `
        <div class="mb-3">
          <h6 class="mb-2">å®¢æˆ¶æª”æ¡ˆ</h6>
          <table class="table table-sm">
            <tbody>
              <tr><th style="width:130px;">å®¢æˆ¶å§“å</th><td>${clientGroup.client || ''}</td></tr>
              <tr><th>æ€§åˆ¥</th><td>${p.gender || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>å¹´é½¡(æ­²)</th><td>${p.age || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>è‚¡é½¡</th><td>${p.experience || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>æ“ä½œæ–¹å¼</th><td>${p.style || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>èˆˆè¶£æ„›å¥½</th><td>${p.hobbies || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>å®¶åº­æƒ…æ³</th><td>${p.family || 'æœªå¡«å¯«'}</td></tr>
              <tr><th>å‚™è¨»</th><td>${p.note || 'â€”'}</td></tr>
            </tbody>
          </table>
        </div>
      `;

      // å®¢æˆ¶æ•´é«”æŠ•å…¥ / ç›ˆè™§
      const totalCostClient = clientGroup.totalCost;
      const totalValueClient = clientGroup.totalValue;
      const totalPnlClient = totalValueClient - totalCostClient;
      const totalRateClient = totalCostClient > 0 ? totalPnlClient / totalCostClient * 100 : 0;

      const holdingsHtml = `
        <div class="mb-2">
          <h6 class="mb-2">æŒå€‰æ˜ç´°ï¼ˆå…± ${clientGroup.holdings.length} æª”ï¼‰</h6>

          <div class="client-summary-card">
            <div class="title">
              ${clientGroup.client || ''} |
              æŠ•å…¥ NT$ ${totalCostClient.toLocaleString('zh-TW', { maximumFractionDigits: 0 })} |
              ç›ˆè™§
              <span class="${totalPnlClient >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                NT$ ${(totalPnlClient >= 0 ? '+' : '') + totalPnlClient.toFixed(0)}
                ${totalCostClient > 0
                  ? ` (${(totalRateClient >= 0 ? '+' : '') + totalRateClient.toFixed(2)}%)`
                  : ''}
              </span>
            </div>
            <div style="font-size:12px;color:#6b7280;">
              è‚¡ç¥¨æª”æ•¸ï¼š${clientGroup.holdings.length} æª”ï½œ
              ç¸½æŒè‚¡æ•¸ï¼š${clientGroup.totalQty.toLocaleString('zh-TW')} è‚¡ï½œ
              ç¸½å¸‚å€¼ï¼šNT$ ${totalValueClient.toLocaleString('zh-TW', { maximumFractionDigits: 0 })}
            </div>
          </div>

          <div class="client-holdings-wrapper mt-2">
            <div class="holding-row-card header">
              <div>è‚¡ç¥¨ / æ¨™ç±¤</div>
              <div>ä»£ç¢¼</div>
              <div class="text-end">æ•¸é‡</div>
              <div class="text-end">æˆæœ¬åƒ¹</div>
              <div class="text-end">å³æ™‚åƒ¹</div>
              <div class="text-end">å¸‚å€¼</div>
              <div class="text-end">ç›ˆè™§</div>
              <div class="text-end">æ“ä½œ</div>
            </div>

            ${clientGroup.holdings.map(r => {
              const qty  = Number(r.quantity) || 0;
              const cost = Number(r.cost) || 0;
              const cur  = Number(r.currentPrice ?? r.cost) || 0;
              const value = qty * cur;
              const pnl   = qty * (cur - cost);
              const rate  = cost > 0 ? (cur - cost) / cost * 100 : 0;
              const rateStr = cost > 0 ? ((rate>=0?'+':'')+rate.toFixed(2)+'%') : '-';
              const pnlClass = pnl >= 0 ? 'badge-pnl-up' : 'badge-pnl-down';

              const typeTag = r.recommendType === 'yes'
                ? '<span class="badge-tag rec">æ¨è–¦</span>'
                : '<span class="badge-tag normal">ä¸€èˆ¬</span>';

              return `
                <div class="holding-row-card body">
                  <div>
                    <div>${r.stockName || ''}</div>
                    <div>${typeTag}</div>
                  </div>
                  <div>${r.code || ''}</div>
                  <div class="text-end">${qty.toLocaleString('zh-TW')}</div>
                  <div class="text-end">${cost || ''}</div>
                  <div class="text-end">${cur || ''}</div>
                  <div class="text-end">
                    ${value ? value.toLocaleString('zh-TW',{maximumFractionDigits:0}) : ''}
                  </div>
                  <div class="text-end">
                    ${pnl
                      ? `<span class="${pnlClass}">${(pnl>=0?'+':'')+pnl.toFixed(0)} (${rateStr})</span>`
                      : '-'}
                  </div>
                  <div class="holding-actions">
                    <!-- é€™è£¡é ç•™ç·¨è¼¯æŒ‰éˆ•ï¼Œä¹‹å¾Œå¯ä¸²æ¥å‰ç«¯ç›¸åŒ API -->
                    <!-- <button class="btn btn-outline-secondary btn-icon-mini">ç·¨è¼¯</button> -->
                    <button class="btn btn-outline-danger btn-icon-mini"
                            onclick="deleteHolding('${r._id}', true)">
                      åˆªé™¤
                    </button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      body.innerHTML = profileHtml + holdingsHtml;

      const modal = new bootstrap.Modal(document.getElementById('clientDetailModal'));
      modal.show();
    }

    // ---------------- åˆªé™¤æŒå€‰ ----------------
    async function deleteHolding(id, fromModal = false) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æŒå€‰å—ï¼Ÿ')) return;
      try {
        const res = await fetch(`${API_BASE}/delete_position`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        const result = await res.json();
        if (!result.success) {
          alert(result.message || 'åˆªé™¤å¤±æ•—');
          return;
        }
        // å¾å‰ç«¯é™£åˆ—ç§»é™¤
        allHoldings = allHoldings.filter(r => r._id !== id);
        buildClientGroups();
        render();
        if (fromModal) {
          // é‡æ–°æ•´ç† Modal å…§å®¹
          const openModal = document.getElementById('clientDetailModal');
          const clientName = document.querySelector('#clientDetailBody table tbody tr td')?.textContent || '';
          if (clientName) showClientDetail(clientName);
        }
      } catch (e) {
        console.error(e);
        alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // ---------------- åŒ¯å‡º CSV ----------------
    function exportCSV() {
      if (!allHoldings.length) {
        alert('ç›®å‰æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
        return;
      }

      let csv = 'å®¢æˆ¶å§“å,è‚¡ç¥¨åç¨±,ä»£ç¢¼,æŒè‚¡æ•¸,è²·å…¥åƒ¹,å³æ™‚åƒ¹,ä¼°ç®—å¸‚å€¼,ä¼°ç®—ç›ˆè™§,æ˜¯å¦æ¨è–¦,æäº¤æ™‚é–“\n';
      allHoldings.forEach(row => {
        const qty  = Number(row.quantity) || 0;
        const cost = Number(row.cost) || 0;
        const cur  = Number(row.currentPrice ?? row.cost) || 0;
        const value = qty * cur;
        const pnl   = qty * (cur - cost);

        csv += [
          row.client || '',
          row.stockName || '',
          row.code || '',
          qty,
          cost,
          cur,
          value.toFixed(0),
          pnl.toFixed(0),
          row.recommendType === 'yes' ? 'æ¨è–¦' : 'ä¸€èˆ¬',
          row.createdAt ? new Date(row.createdAt).toLocaleString() : ''
        ].join(',') + '\n';
      });

      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'å®¢æˆ¶æŒå€‰æ˜ç´°.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
